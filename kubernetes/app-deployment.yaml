apiVersion: apps/v1
kind: Deployment
metadata:
  name: my-app
  namespace: default
spec:
  replicas: 1
  selector:
    matchLabels:
      app: my-app
  template:
    metadata:
      labels:
        app: my-app
    spec:
      serviceAccountName: wif-demo-sa
      containers:
        - name: app
          image: node:18
          command: ["/bin/sh", "-c"]
          args:
            - |
              mkdir -p /app
              cp /src/index.js /app/index.js
              cd /app
              npm install mongodb
              node index.js
          volumeMounts:
            - name: app-code
              mountPath: /src
          env:
            - name: MONGODB_URI_GCP
              valueFrom:
                secretKeyRef:
                  name: atlas-creds
                  key: connection_string_gcp
            - name: MONGODB_URI_AWS
              valueFrom:
                secretKeyRef:
                  name: atlas-creds
                  key: connection_string_aws
      volumes:
        - name: app-code
          configMap:
            name: app-code
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: wif-demo-sa
  annotations:
    # This annotation maps the K8s SA to the GCP Service Account
    iam.gke.io/gcp-service-account: "wif-demo-app-sa@${GCP_PROJECT_ID}.iam.gserviceaccount.com"
---
apiVersion: v1
kind: Service
metadata:
  name: my-app-service
spec:
  type: LoadBalancer
  selector:
    app: my-app
  ports:
    - protocol: TCP
      port: 80
      targetPort: 3000
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: app-code
data:
  index.js: |
    const http = require('http');
    const { MongoClient } = require('mongodb');
    const url = require('url');

    // Connection Clients
    let clientGCP = null;
    let clientAWS = null;

    async function getClient(target) {
        if (target === 'GCP') {
            if (!clientGCP) clientGCP = new MongoClient(process.env.MONGODB_URI_GCP);
            return clientGCP;
        } else {
            if (!clientAWS) clientAWS = new MongoClient(process.env.MONGODB_URI_AWS);
            return clientAWS;
        }
    }

    const htmlDashboard = `
    <!DOCTYPE html>
    <html>
    <head>
        <title>Svenska Spel - Latency Dashboard</title>
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <style>
            body { background-color: #0d0d0d; color: #00ff00; font-family: 'Courier New', Courier, monospace; margin: 0; padding: 20px; }
            .container { max-width: 1000px; margin: 0 auto; text-align: center; }
            h1 { font-size: 3em; text-shadow: 0 0 10px #00ff00; margin-bottom: 10px; }
            .controls { margin: 20px 0; background: #1a1a1a; padding: 20px; border: 1px solid #00ff00; border-radius: 5px; }
            button { background: #000; color: #00ff00; border: 1px solid #00ff00; padding: 10px 20px; font-size: 1.2em; cursor: pointer; margin: 0 10px; transition: all 0.3s; }
            button:hover { background: #00ff00; color: #000; box-shadow: 0 0 15px #00ff00; }
            button:disabled { border-color: #555; color: #555; cursor: not-allowed; box-shadow: none; }
            select, input { background: #000; color: #00ff00; border: 1px solid #00ff00; padding: 10px; font-size: 1.2em; }
            .status { font-size: 1.5em; margin-top: 20px; height: 30px; }
            .grid { display: flex; justify-content: space-around; margin-top: 30px; }
            .card { background: #111; border: 1px solid #333; padding: 20px; width: 45%; }
            h2 { color: #fff; border-bottom: 1px solid #333; padding-bottom: 10px; }
            #latencyChart { max-height: 400px; }
        </style>
    </head>
    <body>
        <div class="container">
            <h1>ATLAS LATENCY PROBE</h1>
            <p>Targeting MongoDB Atlas Clusters</p>
            
            <div class="controls">
                <label>Target: </label>
                <select id="target">
                    <option value="GCP">GCP Finland (Private Endpoint)</option>
                    <option value="AWS">AWS Stockholm (Public Internet)</option>
                </select>
                
                <label>Frequency (ms): </label>
                <input type="number" id="freq" value="1000" step="100" min="100">
                
                <br><br>
                <button id="startBtn" onclick="startPing()">START PING</button>
                <button id="stopBtn" onclick="stopPing()" disabled>STOP</button>
            </div>

            <div class="status" id="statusText">READY TO PROBE...</div>

            <div class="card" style="width: 100%;">
                <canvas id="latencyChart"></canvas>
            </div>
        </div>

        <script>
            let intervalId = null;
            const ctx = document.getElementById('latencyChart').getContext('2d');
            const chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Query Latency (ms)',
                        data: [],
                        borderColor: '#00ff00',
                        backgroundColor: 'rgba(0, 255, 0, 0.1)',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: { beginAtZero: true, grid: { color: '#333' }, ticks: { color: '#00ff00' } },
                        x: { grid: { color: '#333' }, ticks: { color: '#00ff00' } }
                    },
                    plugins: {
                        legend: { labels: { color: '#fff' } }
                    },
                    animation: { duration: 0 }
                }
            });

            async function ping() {
                const target = document.getElementById('target').value;
                const start = Date.now();
                try {
                    const res = await fetch('/ping?target=' + target);
                    const data = await res.json();
                    const latency = data.latency;
                    
                    const now = new Date().toLocaleTimeString();
                    
                    if (chart.data.labels.length > 20) {
                        chart.data.labels.shift();
                        chart.data.datasets[0].data.shift();
                    }
                    
                    chart.data.labels.push(now);
                    chart.data.datasets[0].data.push(latency);
                    chart.update();
                    
                    document.getElementById('statusText').innerText = \`PINGING \${target}: \${latency}ms\`;
                } catch (e) {
                    document.getElementById('statusText').innerText = "ERROR CONNECTING";
                }
            }

            function startPing() {
                const freq = document.getElementById('freq').value;
                document.getElementById('startBtn').disabled = true;
                document.getElementById('stopBtn').disabled = false;
                document.getElementById('target').disabled = true;
                
                ping(); // First one immediately
                intervalId = setInterval(ping, freq);
            }

            function stopPing() {
                clearInterval(intervalId);
                document.getElementById('startBtn').disabled = false;
                document.getElementById('stopBtn').disabled = true;
                document.getElementById('target').disabled = false;
                document.getElementById('statusText').innerText = "STOPPED";
            }
        </script>
    </body>
    </html>
    `;

    const server = http.createServer(async (req, res) => {
        const reqUrl = url.parse(req.url, true);

        if (req.method === 'GET' && reqUrl.pathname === '/') {
            res.writeHead(200, { 'Content-Type': 'text/html' });
            res.end(htmlDashboard);
        } else if (req.method === 'GET' && reqUrl.pathname === '/ping') {
            const target = reqUrl.query.target || 'GCP';
            const start = Date.now();
            try {
                const client = await getClient(target);
                await client.connect();
                const db = client.db('wif_demo_db');
                // Run a lightweight command
                await db.command({ ping: 1 });
                
                const latency = Date.now() - start;
                res.writeHead(200, { 'Content-Type': 'application/json' });
                res.end(JSON.stringify({ latency: latency, target: target }));
            } catch (e) {
                console.error(e);
                res.writeHead(500, { 'Content-Type': 'application/json' });
                res.end(JSON.stringify({ error: e.toString() }));
            }
        } else {
            res.writeHead(404);
            res.end('Not Found');
        }
    });

    server.listen(3000, () => {
        console.log('Hacker Dashboard running on port 3000');
    });
